#!/usr/bin/env bash

##############################################
#   Author: RMCJ <rmichael1001@gmail.com>
#   Project: scriptctl
#   Version: 1.0
#
#   Usage:
#
#   Description:
#		Manage user scripts
##############################################

# shellcheck disable=SC1091
source "${SCRIPTS:=$HOME/.local/bin}"/00-api.sh

# Preprocessor flags
DISABLE_ROOT

####################################

SCRIPTS="${SCRIPTS:=$HOME/.local/bin}"

function _help() {
	PRINT "$(SCRIPTNAME) - Manage user scripts"
	PRINT
	PRINT "Usage:\t\tscriptctl <flag> <args?>"
	PRINT "Example:\tscriptctl --list"
	PRINT
	{
		PRINT "-------------|------|---------------------|"
		PRINT "Flag|Args|Description"
		PRINT "-------------|------|---------------------|"
		PRINT "-l, --list|n/a|List all user scripts"
		PRINT "-c, --create|<name>|Create a new script"
		PRINT "-e, --edit|<name>|Edit an existing script"
		PRINT "-r, --delete|<name>|Delete a script"
		PRINT "|||"
		PRINT "-h, --help|n/a|Show this prompt"
	} | column -t -s'|'
}

function _ls() {
	dir="${PWD}"
	cd "${SCRIPTS}" || exit
	ls -alvhF --group-directories-first
	cd "${dir}" || exit
}

function _script_conditions() {
	# Check for script name argument
	test -z "${1}" && PRINT "You must specify a script name!" && return 1

	# Check if script exists
	test ! -e "${SCRIPTS}"/"${1}" && PRINT "Script '${1}' doesn't exist!" && return 1
}

function _mk() {
	_script_conditions "$@" || return 1

	cp "${SCRIPTS}"/00-template.sh "${SCRIPTS}"/"${1}".sh &&
		mv "${SCRIPTS}"/"${1}".sh "${SCRIPTS}"/"${1}" &&
		chmod +x "${SCRIPTS}"/"${1}" && ${EDITOR:=nano} "${SCRIPTS}"/"${1}" &&
		PRINT "scriptctl: Created '${1}'."
}

function _ed() {
	_script_conditions "$@" || return 1

	# Edit the script
	${EDITOR:=nano} "${SCRIPTS}"/"${1}" &&
		PRINT "scriptctl: Edited '${1}'."
}

function _rm() {
	_script_conditions "$@" || return 1

	# Confirm whether to delete script
	read -r -p "Are you sure you want to delete '${1}'? (y/N) " confirm

	# If 'no' or empty string passed, cancel.
	CHECK_NO "$confirm" && PRINT "Cancelled." && return 1

	# Delete script
	rm -f "${SCRIPTS}"/"${1}" &&
		PRINT "scriptctl: Removed '${1}'."
}

# If no arguments are given, just show help prompt.
test $# -eq 0 && _help && exit 0

# Iterate over all arguments and evaluate them
while test $# -gt 0; do

	case "$(LOWERCASE "${1}")" in

	\? | -h | --help)
		shift
		_help
		exit $?
		;;

	-l | --list)
		shift
		_ls
		exit $?
		;;

	-c | --create)
		shift
		_mk "$@"
		exit $?
		;;

	-e | --edit)
		shift
		_ed "$@"
		exit $?
		;;

	-r | --delete)
		shift
		_rm "$@"
		exit $?
		;;

	*) PRINT "scriptctl: Invalid argument '${1}'" && exit 1 ;;

	esac

done
